@page "/fetchdata"
@using BlazorServerTest.Data;
@using BlazorServerTest.Services;
@inject WeatherForecastService ForecastService

<PageTitle>Weather forecast</PageTitle>

<h1>Weather forecast</h1>

<p>This component demonstrates fetching data from a service.</p>

@if (forecasts == null)
{
    <p><em>Loading...</em></p>
}
else
{
    <button onclick="@(async () => await ForecastService.AddDefault())">➕</button>
	<table class="table">
		<thead>
		<tr>
			<th>Date</th>
			<th>Temp. (C)</th>
			<th>Temp. (F)</th>
			<th>Summary</th>
		</tr>
		</thead>
		<tbody>
		@foreach (var forecast in forecasts)
		{
			<tr>
				<td>@forecast.Date.ToShortDateString()</td>
				<td>@forecast.TemperatureC</td>
				<td>@forecast.TemperatureF</td>
				<td>@forecast.Summary</td>
				<td><button onclick="@(async () => await ForecastService.Delete(forecast.Id))">❌</button></td>
			</tr>
		}
		</tbody>
	</table>
	<nav aria-label="Page navigation">
		<ul class="pagination">
			<li class="page-item @(currentPage == 1 ? "disabled" : "")">
				<a class="page-link" @onclick="() => SetPage(currentPage - 1)">Previous</a>
			</li>
			@for (var i = 1; i <= totalPages; i++)
			{
				var pageNum = i;
				<li class="page-item @(currentPage == pageNum ? "active" : "")">
					<a class="page-link" @onclick="() => SetPage(pageNum)">@pageNum</a>
				</li>
			}
			<li class="page-item @(currentPage == totalPages ? "disabled" : "")">
				<a class="page-link" @onclick="() => SetPage(currentPage + 1)">Next</a>
			</li>
		</ul>
	</nav>
}

@code {
    private IEnumerable<WeatherForecast>? rawData;
	private List<WeatherForecast> forecasts;
	private int pageSize = 2;
	private int currentPage = 1;
	private int totalPages;

    protected override async Task OnInitializedAsync()
    {
	    rawData = await ForecastService.GetForecastAsync(DateOnly.FromDateTime(DateTime.Now));

		totalPages = (int)Math.Ceiling(rawData.Count() / (double)pageSize);
		forecasts = rawData.Skip((currentPage - 1) * pageSize).Take(pageSize).ToList();
    }

	private void SetPage(int newPage)
	{
		currentPage = newPage;
		forecasts = rawData.Skip((currentPage - 1) * pageSize).Take(pageSize).ToList();
		StateHasChanged();
	}
}
