@page "/fetchdata"
@using BlazorServerTest.Core.Data.Entities
@using BlazorServerTest.Core.Data.Repositories
@inject RecipeRepository RecipeRepository

<PageTitle>Weather forecast</PageTitle>

<h1>Weather forecast</h1>

<p>This component demonstrates fetching data from a repository.</p>

@if (recipes == null)
{
    <p><em>Loading...</em></p>
}
else
{
	<button onclick="@AddDefaultHandler">➕</button>
    <ModalFormComponent OnDataSaved="@DataAddedHandler" />
    <CascadingValue Value="Message">
        <ShowDataModalComponent />
    </CascadingValue>
	<input type="search" class="form-control" id="search" @bind="SearchTerm" @bind:event="oninput" placeholder="Enter search term..." autocomplete="off" />

	<p>@SearchTerm</p>
	<p>@pageSize</p>

	<table class="table">
		<thead>
		<tr>
            <th>@nameof(Recipe.Id)</th>
            <th>@nameof(Recipe.Name)</th>
            <th>@nameof(Recipe.Description)</th>
            <th>@nameof(Recipe.CookTime)</th>
            <th>@nameof(Recipe.PrepTime)</th>
            <th>Categories</th>
			<th></th>
		</tr>
		</thead>
		<tbody>
		@foreach (var recipe in recipes)
		{
			<tr>
				<td>@recipe.Id</td>
				<td>@recipe.Name</td>
				<td>@recipe.Description</td>
                <td>@recipe.CookTime</td>
                <td>@recipe.PrepTime</td>
                <td>@recipe.Categories.Count()</td>
				<td><ConfirmModalComponent ButtonText="❌" Message="Do you rale want to delete?" Id="@recipe.Id" OnYes="@DeleteHandler" /></td>
			</tr>
		}
		</tbody>
	</table>
	<nav aria-label="Page navigation">
		<ul class="pagination">
			<li class="page-item @(currentPage == 1 ? "disabled" : "")">
				<a class="page-link" @onclick="() => SetPage(currentPage - 1)">Previous</a>
			</li>
			@for (var i = 1; i <= totalPages; i++)
			{
				var pageNum = i;
				<li class="page-item @(currentPage == pageNum ? "active" : "")">
					<a class="page-link" @onclick="() => SetPage(pageNum)">@pageNum</a>
				</li>
			}
			<li class="page-item @(currentPage == totalPages ? "disabled" : "")">
				<a class="page-link" @onclick="() => SetPage(currentPage + 1)">Next</a>
			</li>
		</ul>
	</nav>
}

@code {
    private string Message { get; set; } = "Test message";
    private List<Recipe> rawData;
	private List<Recipe> recipes;
	private int pageSize = 4;
	private int currentPage = 1;
	private int totalPages;

	string _searchTerm;
	private string SearchTerm
	{
		get => _searchTerm;
		set
		{
			_searchTerm = value;
			OnSearchChanged();
		}
	}

	protected override async Task OnInitializedAsync()
    {
		rawData = (await RecipeRepository.GetForecastAsync(String.Empty)).ToList();
	    AuxCalculating();
    }

	private void AuxCalculating()
	{
		totalPages = (int)Math.Ceiling(rawData.Count() / (double)pageSize);
		if (currentPage > totalPages)
		{
			currentPage = totalPages;
		}

		recipes = rawData.Skip((currentPage - 1) * pageSize).Take(pageSize).ToList();
	}

    private async Task AddDefaultHandler()
    {
		var addedItem = await RecipeRepository.AddDefault();
		DataAddedHandler(addedItem);
    }

	private void DataAddedHandler(Recipe addedItem)
	{
		rawData.Add(addedItem);
		AuxCalculating();
		StateHasChanged();
	}

	private void SetPage(int newPage)
	{
		currentPage = newPage;
		recipes = rawData.Skip((currentPage - 1) * pageSize).Take(pageSize).ToList();
		StateHasChanged();
	}

	private async Task DeleteHandler(int id)
	{
		await RecipeRepository.Delete(id);
		rawData = rawData.Where(x => x.Id != id).ToList();
		AuxCalculating();
		StateHasChanged();
	}

	private async Task OnSearchChanged()
	{
		Console.WriteLine(SearchTerm);
		rawData = (await RecipeRepository.GetForecastAsync(SearchTerm)).ToList();
		AuxCalculating();
		StateHasChanged();
	}
}
